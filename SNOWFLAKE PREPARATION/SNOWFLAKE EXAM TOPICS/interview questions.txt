Youtube: https://www.youtube.com/watch?v=Jg5KQ7UpaqI

Q) what is snowpipe and write syntax for creating snowpipe?
Azure event based triggers are needed to trigger this snowpipe

- Continuous data ingestion service
- Serverless compute model
- A pipeline for loading fresh data in micro-batches as soon as it is available.

CREATE OR REPLACE PIPE PIPE_NAME
AUTO_INGEST = TRUE
AS
COPY INTO DBNAME.SCHEMANAME.TABLENAME FROM @EXTERNAL_STAGE_NAME;

DESC PIPE PIPE_NAME;

Q) What are the editions of snowflake ?
A) 4 editions are:
- standard ($2.7/credit)
- Enterprise ($4/credit)
- Business Critical ($5/credit)

Q) VW size in your project? how many clusters?
A) - Size can be from XS to 6XL
 - No.of Clusters depends on no.of concurrent jobs running
 - 'M' Size with 4 clusters
 - Dev contains small data and small jobs but prod needs huge data & jobs. So greater than 'M' size like L, XL, ....

Q) Diff table types in snowflake
- Permanent table: timetravel is 0-90 days of retention, 7 days fail safe
- Transient table: similar to permanent but no protection & data recovery with 0-1 day retention. No fail safe
- Temporary table: Only for the session , 0-1 retention no fail safe
Note: Tables of transient db/schema are of default 0-1 retention period!!!

Why transient table? 
A) To create stage tables which doesn't require protection and recovery like permanent tables. Can use beyond the session. Like external stages wehre we can retreive data from the external cloud whenever required.

Why temporary table?
A) For stored procedures for intermediate data processing & get dropped after stored procedure execution completed.

Q) Conversion of Temp/Transient table into Permanent table is not possible even Vise Versa!!
Q) Diff caches in snowflake"
A) Result Cache: If underlying data has not changed then it holds query results for 24 hours across available VM's. So one user query available for another user. "ALTER SESSION" to turn off result cache!!

Local Disk Cache: Cache data of SQL queries it gets retrieved from "Remote Disk Storage", and cached in SSD and memory.

For Partner connect, Go to Data Products --> Partner Connect 
In order to configure the connection with Snowflake, the following objects will be created in your Snowflake account:

Database: PC_TALEND_DB
Warehouse: PC_TALEND_WH (X-Small)
System User: PC_TALEND_USER
System Password: Autogenerated & Randomized
System Role: PC_TALEND_ROLE
		Role PUBLIC will be granted to the PC_TALEND_ROLE
		Role PC_TALEND_ROLE will be granted to the SYSADMIN role


Q) How the Stream tracks the changes occuring a table?
A) Every stream contains 2 fields to determine Insert/Update/Delete record

METADATA$ACTION - Insert/Delete
METADATA$ISUPDATE - True/False

METADATA$ACTION = INSERT and METADATA$ISUPDATE = FALSE -> Insert Record
METADATA$ACTION = DELETE and METADATA$ISUPDATE = FALSE -> Delete Record
METADATA$ACTION = INSERT and METADATA$ISUPDATE = TRUE -> Update Record

Note: A Streams  records update operation as a set of Delete(delete old record) and Insert (insert updated record)

39) 3 Types of Streams:

Standard Streams: Supports all DML changes

Append-only Streams: Supports only Inserts but not Update & Delete

Insert-only Streams: Supports only external table's Inserts only.

40) Task:
A Tasak object is used schedule the execution of a SQL statement, including statements that call stored procedures.
-> We have to provide the VM to execute the sql stmts.
-> We can also use Cron scheduling in Tasks

CREATE OR REPLACE TASK TASK_NAME
 WAREHOUSE = COMPUTE_WH
 SCHEDULE = '1 MINUTE'
 AS
 'SQL Statement'

CREATE OR REPLACE TASK TASK_NAME
 WAREHOUSE = COMPUTE_WH
 SCHEDULE = 'USING CRON 0 7 * * * UTC'
 AS
 'SQL Statement';
Note: Nowadays we can execute Tasks virtually. So, no need to execute the tasks.

41) How to implement column level security in Snowflake?
A) Snowflake supports Dynamic Data Masking on columns of tables & views. 
 We can partially or fully mask the data from Un-authorized users.
- So masking policies only while displaying but not written on the file like this!!

--Creating masking policy
create or replace masking policy policy_name
 as (val varchar) returns varchar ->
	case
	when current_role() in ('SYSADMIN','ACCOUNTADMIN') then val
	else '#######'
	end;

42) Write syntax to create a stored proc and an UDF.
A)
create or replace procedure proc_name()
 returns datatype
 language sql /*can write in sql, java, java script, scala */
 AS
 $$
   sql statements;
 $$
 ;

create function area_of_circle(radius float)
 returns float /* can write in sql, java, java script */
 as
 $$
   pi() * radius * radius
 $$
;

43) Best practices to follow in Snowflake?
A) 
1) Choose appropriate table type
2) Define cluster keys on large table only and choose proper cluster keys. Like columns used in filter & join conditions.
3) Reduce default retention period
4) Enable auto suspend and auto resume
5) Choose appropriate warehouse size, use scale-up and scale-out effectively
6) Understand storage and compute costs

44) Diff bw where and having?
A) where is to filter data while Having is to filter summary data after applying the grouping functions like count, sum, avg etc.

45) delete duplicate records from a table?
A) DELETE FROM TABLE_NAME
 WHERE ROWID NOT IN
	(SELECT MAX(ROWID) FROM TABLE_NAME GROUP BY Key1, Key2);

47) 
Table A, Table B
1,1
2,2
1,2
3,4

Ans:
A inner join B - 4 records (1-1,1-1,2-2,2-2) null never matches with null!
A left outer join B - 6 (1-1,1-1,2-2,2-2,3-no_match, null-no_match) All the records from inner join & also left table records!
A right outer join B - 6 (1-1,1-1,2-2,2-2,4-no_match, null-no_match) All the records from inner join & also right table records!
A full outer join B - 8 (1-1,1-1,2-2,2-2,4-no_match, 3-no_match, null-no_match, no_macth-null ) InnerJoin records(4) + distinct records of both tables(2) + 2 null records from both the tables(2).

Note: Null never matches to a null

48) Query to fetch Dept wise 3rd highest salary?
A) select dept_id, salary from emp
qualify row_number() over(partition by dept_id order by salary desc) = 3;

If your database does not support Qualify, use below query.

select dept_id, salary from
(
 select dept_id, salary from
 dense_rank() over(partition by dept_id order by salary desc) RNK
 from emp
) ABC
WHERE RNK = 3;

49) Diff bw Coalesce and Decode?

51) convert a timestamp to date in snowflake?
A)
To extract date from timestamp
select to_date();

to extract year, month, day from timestamp
select year(to_date());
select month(to_date());
select day(to_date());

52) Fetch only numeric characters from a string in Snowflake?
A)
select trim(regexp_replace(string, '[^[:digit:]]', '')) as numeric_value
from
(select '' as string) a;

53) Performance tuning techniques of sql queries?
A) 
1) Define proper Indexes
2) Define proper partitions keys (cluster keys in snowflake)
3) select only required fields, don't put select * blindly.
4) Replace OR with UNION if possible
5) Use UNION instead of UNION ALL if you are sure there are no duplicates.
6) Use CTEs instead of subqueries if you want to use same result set at multiple places in the query.
7) Use Inner Join instead of putting Cross Join + Where clause
8) Collecting missing stats on table will help in Teradata
9) Use materialized views for faster data retrieval and continuous data availabilty.
10) Look at query execution plan or Query profile to understand where is the bottleneck.






-- Applying policy on column
ALTER TABLE IF EXISTS table_name MODIFY COLUMN column_name
SET MASKING POLICY policy_name;

select * from manage_db.information_schema.PROCEDURES 
WHERE PROCEDURE_NAME = 'name of procedure'; 


desc view manage_db.information_schema.PROCEDURES;
Details: PROCEDURE_CATALOG, PROCEDURE_SCHEMA, PROCEDURE_NAME, PROCEDURE_OWNER  so on....

*****************example1: *****************
CREATE PROCEDURE SelectAllCustomers @City nvarchar(30)
AS
SELECT * FROM Customers WHERE City = @City
GO;


MySQL stored procedure:

DELIMITER //
CREATE PROCEDURE us_customers ()
BEGIN
SELECT customer_id, first_name
FROM Customers
WHERE Country = 'USA';
END //
DELIMITER ;

Oracle:
CREATE PROCEDURE us_customers
AS res SYS_REFCURSOR;  
BEGIN
open res for
SELECT customer_id, first_name
FROM Customers
WHERE country = 'USA';
DBMS_SQL.RETURN_RESULT(res);
END;

***************** Examples2*****************

CREATE TABLE Product
(ProductID INT, ProductName VARCHAR(100) )
GO
 
CREATE TABLE ProductDescription
(ProductID INT, ProductDescription VARCHAR(800) )
GO
 
INSERT INTO Product VALUES (680,'HL Road Frame - Black, 58')
,(706,'HL Road Frame - Red, 58')
,(707,'Sport-100 Helmet, Red')
GO
 
INSERT INTO ProductDescription VALUES (680,'Replacement mountain wheel for entry-level rider.')
,(706,'Sturdy alloy features a quick-release hub.')
,(707,'Aerodynamic rims for smooth riding.')
GO

************** CREATEING A SIMPLE stored Procedure: ***********

CREATE PROCEDURE GetProductDesc
AS
BEGIN
SET NOCOUNT ON
 
SELECT P.ProductID,P.ProductName,PD.ProductDescription  FROM 
Product P
INNER JOIN ProductDescription PD ON P.ProductID=PD.ProductID
 
END;

*********** Stored Procedure with parameters ****************

CREATE PROCEDURE GetProductDesc_withparameters
(@PID INT)
AS
BEGIN
SET NOCOUNT ON
 
SELECT P.ProductID,P.ProductName,PD.ProductDescription  FROM 
Product P
INNER JOIN ProductDescription PD ON P.ProductID=PD.ProductID
WHERE P.ProductID=@PID
 
END;


EXEC GetProductDesc_withparameters 706





























 



























































